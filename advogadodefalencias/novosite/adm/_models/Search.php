<?phpob_start();session_start();include '../../_app/Config.inc.php';require_once '../../_app/Helpers/Trigger.php';$trigger = new Trigger;$action = filter_input(INPUT_GET, 'action', FILTER_DEFAULT);$data = filter_input_array(INPUT_POST, FILTER_SANITIZE_STRIPPED);if (isset($data['title']) && $data['title'] === 'search-cfop'):    $Read = new Read;//    $Read->ExeRead("cfop", "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']}");    $Read->ExeRead("cfop");    $Data = array();    foreach ($Read->getResult() as $item) {        $SubData = array();        $SubData[] = "                    <tr>                        <td>                            <a class='select_opt' data-select='.input_cfop' data-value='{$item['CFOP']}'>{$item['CFOP']}</a>                        </td>                        <td>                             {$item['Descricao']}                        </td>                    </tr>";        $Data[] = $SubData;    }    $json = $Data;    echo json_encode($json);endif;if (isset($data['title']) && $data['title'] === 'search-icms'):    $Read = new Read;    $Read->ExeRead("aliqicmsestado", "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']}");    $Data = array();    foreach ($Read->getResult() as $item) {        $SubData = array();        $SubData[] = "                    <tr>                        <td>                            <a class='select_icms' data-value='{$item['Aliquota']}'>{$item['Aliquota']}</a>                        </td>                        <td>                             {$item['Estado']}                        </td>                    </tr>";        $Data[] = $SubData;    }    $json = $Data;    echo json_encode($json);endif;if (isset($data['action'])):    switch ($data['action']):        case 'requests-gp':            unset($data['action']);            $vlr = $data['vlr'];            $Ped = HOME . "/adm/painel.php?exe=billstoreceive/create";            $Url = explode('&', $_SERVER['HTTP_REFERER']);            if (!isset($data['data'])) {                $json['notify'] = $trigger->notify('Mensagem 1', 'blue', 'lnr lnr-warning', 4000);                echo json_encode($json);                return;            }            if (in_array('', $data['data'])) {                $json['notify'] = $trigger->notify('Mensagem 2', 'blue', 'lnr lnr-warning', 4000);                echo json_encode($json);                return;            }            $Tl = floatval($vlr);            $c = count($data['data']);            $n = 1;            $Tld = ($Tl / $c);            $bool = false;            if (isset($_SESSION['cobranca'])) {                unset($_SESSION['cobranca']);            }            foreach ($data['data'] as $k => $i):                $_SESSION['cobranca'][$n] = array(                    'DVENC' => date('Y-m-d', strtotime("+ {$i} days")),                    'DEMIS' => date("Y-m-d"),                    'VLPAG' => $Tld,                    'Dias' => $i,                    'NPARC' => $n                );                $a['prc'] = $n;                $a['vl'] = $Tld;                $a['demi'] = date("Y-m-d");                $a['dias'] = $i;                $a['data'] = date('Y-m-d', strtotime("+ {$i} days"));                $bool = true;                $json['gerar'][] = $a;                $i++;                $n++;            endforeach;            if ($bool) {                $json['gp'] = "gp";                echo json_encode($json);                return;            }            $json['notify'] = $trigger->notify('Mensagem 3', 'blue', 'lnr lnr-warning', 4000);            echo json_encode($json);            return;            break;        case 'page':            unset($data['action']);            $bool = $data['bool'];            if ($bool) {                $_SESSION['page'] = "fechar";                echo json_encode(true);                return;            }            break;        case 'cfop':            unset($data['action']);            $Read = new Read;            $Read->ExeRead("cfop",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND (CFOP LIKE '%' :value '%' OR Descricao LIKE '%' :value '%')",                    "value={$data['buscar']}");            $Data = array();            foreach ($Read->getResult() as $item) {                $SubData = array();                $SubData[] = "                    <tr>                        <td>                            <a class='select_opt' data-select='.input_cfop' data-value='{$item['CFOP']}' >{$item['CFOP']}</a>                        </td>                        <td>                             {$item['Descricao']}                        </td>                    </tr>";                $Data[] = $SubData;            }            $json = array(                "searchbol" => true,                "searchclass" => ".app_modal_select_cfop",                "search" => $Data            );            echo json_encode($json);            break;        case 'requests-product'://            var_dump($data);            if (!empty($data['code'])) {                $read = new Read();                $read->FullRead("SELECT * FROM cadpro WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND DESCRICAO LIKE '%{$data['code']}%' LIMIT 10");                if ($read->getResult()) {                    foreach ($read->getResult() as $item) {                        $item['product_code'] = $item['IdProduto'];                        $item['product_name'] = $item['DESCRICAO'];                        $item['ean'] = $item['EAN'];                        $item['product_price_full'] = number_format($item['PRCONS'], 2, ',', '.');                        $item['product_price_installment'] = number_format($item['PRCUST'] / 5, 2, ',', '.');                        $json['product'][] = $item;                    }                } else {                    $json['product_clear'] = true;                    echo json_encode($json);                    break;                }            } else {                $json['product_clear'] = true;                echo json_encode($json);                break;            }            echo json_encode($json);            break;        case 'product':            unset($data['action']);            $Code = (int) $data['code'];            $Read = new Read;            $Read->ExeRead("cadpro",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND IdProduto = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $json = array(                    "product_clear" => true,                    "cod" => $Read->getResult()[0]['IdProduto'],                    "name" => $Read->getResult()[0]['DESCRICAO'],                    "ean" => $Read->getResult()[0]['EAN'],//                    "price" => number_format($Read->getResult()[0]['PRCONS'], 2, ',', '.'),                    "price" => $Read->getResult()[0]['PRCONS'],                    "quant" => 1,                    "comi" => 0                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'requests-item':            unset($data['action']);            $Ped = HOME . "/adm/painel.php?exe=requests/create";            $Url = explode('&', $_SERVER['HTTP_REFERER']);            if ($Url[0] == $Ped) {                $Sess = "pedvenda";            } else {                $Sess = "pedcompra";            }//            var_dump($Sess);            $Code = (int) $data['IdProduto'];            $Read = new Read;            $Read->ExeRead("cadpro",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND IdProduto = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $time = uniqid($Read->getResult()[0]['IdProduto']);                $_SESSION[$Sess]['produto'][$time] = array(                    'IdProduto' => $Read->getResult()[0]['IdProduto'],                    'DESCRICAO' => $Read->getResult()[0]['DESCRICAO'],                    'QUANT' => $data['QUANT'],                    'PRCVEND' => $Read->getResult()[0]['PRCONS'],                    'VlCom' => $data['VlCom'],                    'LocSai' => $data['local'],                    'chave' => $time                );                $json = array(                    "reset" => true,                    "addproduct" => true,                    "cod" => $Read->getResult()[0]['IdProduto'],                    "nome" => $Read->getResult()[0]['DESCRICAO'],                    "preco" => $Read->getResult()[0]['PRCONS'],                    "quant" => $data['QUANT'],                    "comi" => $data['VlCom'],                    "local" => $data['local'],                    "chave" => $time                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'requests-update-item':            unset($data['action']);            $Code = (int) $data['IdProduto'];            $Ped = HOME . "/adm/painel.php?exe=requests/create";            $Url = explode('&', $_SERVER['HTTP_REFERER']);            if ($Url[0] == $Ped) {                $Sess = "pedvenda";            } else {                $Sess = "pedcompra";            }            $Read = new Read;            $Read->ExeRead("cadpro",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND IdProduto = :c LIMIT 1",                    "c={$Code}");            $Vlat = ($_SESSION[$Sess]['produto'][$data['chave']]['PRCVEND'] * $_SESSION[$Sess]['produto'][$data['chave']]['QUANT']);            if ($Read->getResult()) {                $_SESSION[$Sess]['produto'][$data['chave']] = array(                    'IdProduto' => $Read->getResult()[0]['IdProduto'],                    'DESCRICAO' => $Read->getResult()[0]['DESCRICAO'],                    'QUANT' => $data['QUANT'],                    'PRCVEND' => $Read->getResult()[0]['PRCONS'],                    'VlCom' => $data['VlCom'],                    'LocSai' => $data['local'],                    'chave' => $data['chave']                );                $json = array(                    "reset" => true,                    "updateproduct" => true,                    "chave" => $data['chave'],                    "cod" => $Read->getResult()[0]['IdProduto'],                    "nome" => $Read->getResult()[0]['DESCRICAO'],                    "preco" => $Read->getResult()[0]['PRCONS'],                    "quant" => $data['QUANT'],                    "comi" => $data['VlCom'],                    "local" => $data['local'],                    "vlat" => $Vlat                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'requests-remove-item':            unset($data['action']);            $Key = $data['code'];            $Ped = HOME . "/adm/painel.php?exe=requests/create";            $Url = explode('&', $_SERVER['HTTP_REFERER']);            if ($Url[0] == $Ped) {                $Sess = "pedvenda";            } else {                $Sess = "pedcompra";            }            if (count($_SESSION[$Sess]['produto']) == 1) {                unset($_SESSION[$Sess]['produto']);                unset($_SESSION[$Sess]['pedido']);            } else {                unset($_SESSION[$Sess]['produto'][$Key]);            }            echo json_encode(true);            return;            break;        case 'requests-gp-remove':            unset($data['action']);            $Key = $data['code'];            $Ped = HOME . "/adm/painel.php?exe=requests/create";            $Url = explode('&', $_SERVER['HTTP_REFERER']);            if ($Url[0] == $Ped) {                $Sess = "pedvenda";            } else {                $Sess = "pedcompra";            }            if (count($_SESSION[$Sess]['cobranca']) == 1) {                unset($_SESSION[$Sess]['cobranca']);            } else {                unset($_SESSION[$Sess]['cobranca'][$Key]);            }            echo json_encode(true);            return;            break;        case 'purchase-item':            unset($data['action']);            $Code = (int) $data['IdProduto'];            $Read = new Read;            $Read->ExeRead("cadpro",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND IdProduto = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $time = uniqid($Read->getResult()[0]['IdProduto']);                $_SESSION['pedcompra']['produto'][$time] = array(                    'IdProduto' => $Read->getResult()[0]['IdProduto'],                    'DESCRICAO' => $Read->getResult()[0]['DESCRICAO'],                    'QUANT' => $data['QUANT'],                    'PRCVEND' => $Read->getResult()[0]['PRCONS'],                    'VlCom' => $data['VlCom'],                    'LocSai' => $data['local'],                    'chave' => $time                );                $json = array(                    "reset" => true,                    "addproduct" => true,                    "cod" => $Read->getResult()[0]['IdProduto'],                    "nome" => $Read->getResult()[0]['DESCRICAO'],                    "preco" => $Read->getResult()[0]['PRCONS'],                    "quant" => $data['QUANT'],                    "comi" => $data['VlCom'],                    "local" => $data['local'],                    "chave" => $time                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'purchase-update-item':            unset($data['action']);            $Code = (int) $data['IdProduto'];            $Read = new Read;            $Read->ExeRead("cadpro",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND IdProduto = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $_SESSION['pedcompra']['produto'][$data['chave']] = array(                    'IdProduto' => $Read->getResult()[0]['IdProduto'],                    'DESCRICAO' => $Read->getResult()[0]['DESCRICAO'],                    'QUANT' => $data['QUANT'],                    'PRCVEND' => $Read->getResult()[0]['PRCONS'],                    'VlCom' => $data['VlCom'],                    'LocSai' => $data['local'],                    'chave' => $data['chave']                );                $json = array(                    "reset" => true,                    "updateproduct" => true,                    "chave" => $data['chave'],                    "cod" => $Read->getResult()[0]['IdProduto'],                    "nome" => $Read->getResult()[0]['DESCRICAO'],                    "preco" => $Read->getResult()[0]['PRCONS'],                    "quant" => $data['QUANT'],                    "comi" => $data['VlCom'],                    "local" => $data['local']                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'purchase-remove-item':            unset($data['action']);            $Key = $data['code'];            unset($_SESSION['pedcompra']['produto'][$Key]);            echo json_encode(true);            return;            break;        case 'purchase-gp-remove':            unset($data['action']);            $Key = $data['code'];            if (count($_SESSION['pedcompra']['cobranca']) == 1) {                unset($_SESSION['pedcompra']['cobranca']);            } else {                unset($_SESSION['pedcompra']['cobranca'][$Key]);            }            echo json_encode(true);            return;            break;        case 'purchase-gp':            unset($data['action']);//            var_dump($data);            if (!isset($data['data'])) {                $json["message"] = $Message->info("Prazos vazio, favor preencha o campo.")->render();                echo json_encode($json);                return;            }            if (in_array('', $data['data'])) {                $json["message"] = $Message->info("Prazos vazio, favor preencha o campo.")->render();                echo json_encode($json);                return;            }            if (isset($_SESSION['pedcompra']['produto'])):                $T = null;                foreach ($_SESSION['pedcompra']['produto'] as $k => $item):                    $T += ($item['PRCVEND'] * $item['QUANT']);                endforeach;                $Tl = ((floatval($T) + floatval($_SESSION['pedcompra']['pedido']['vtAcrecimo']) - floatval($_SESSION['pedcompra']['pedido']['vtDesconto'])));            else:                $json["message"] = $Message->info("Não a itens cadastrado.")->render();                echo json_encode($json);                return;            endif;            $c = count($data['data']);            $n = 1;            $Tld = ($Tl / $c);            $bool = false;            if (isset($_SESSION['pedcompra']['cobranca'])) {                unset($_SESSION['pedcompra']['cobranca']);            }            foreach ($data['data'] as $k => $i):                $_SESSION['pedcompra']['cobranca'][$n] = array(                    'DVENC' => date('Y-m-d', strtotime("+ {$i} days")),                    'DEMIS' => date("Y-m-d"),                    'VLPAG' => $Tld,                    'Dias' => $i,                    'NPARC' => $n                );                $a['prc'] = $n;                $a['vl'] = $Tld;                $a['demi'] = date("Y-m-d");                $a['dias'] = $i;                $a['data'] = date('Y-m-d', strtotime("+ {$i} days"));                $bool = true;                $json['gerar'][] = $a;                $i++;                $n++;            endforeach;            if ($bool) {                $json['gp'] = "gp";                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Erro ao gerar parcelas, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'billstoreceive-views':            unset($data['action']);            $Code = (int) $data['code'];            $Read = new Read;            $Read->FullRead("SELECT * FROM ctrec INNER JOIN n_clientes ON IdCliente = id_cli WHERE NCONT = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $json = array(                    "views" => true,                    "html" => '                        <div class="row-m">                        <div class="row-m">                        <div class="row-m">                                        <label>                                            Cliente                                        </label>                                         <span class="span_views">' . Check::DadosV($Read->getResult()[0]['nome_cli']) . '</span>                                        </div>                                        <div class="row-m">                                        <label>                                            N° Documento                                        </label>                                         <span class="span_views">' . Check::DadosV($Read->getResult()[0]['NDOC']) . '</span>                                        </div>                                        </div>                                         <div class="row-m">                                    <label>                                        Situação                                    </label>                                   <span class="span_views">' . Check::Situacao($Read->getResult()[0]['Situacao']) . '</span>                            </div>                                        </div>                            <div class="row-m">        <div class="row-m">        <div class="row-m">            <label>                Descrição            </label>            <span class="span_views">' . $Read->getResult()[0]['DESCRICAO'] . '</span>        </div>        <div class="row-m">            <label>                Data de Emissão            </label>            <span class="span_views">' . Check::DataBr($Read->getResult()[0]['DEMIS']) . '</span>        </div>        </div>        <div class="row-m">            <label>                Data de Vencimento            </label>            <span class="span_views">' . Check::DataBr($Read->getResult()[0]['DVENC']) . '</span>        </div>    </div>                            <div class="row-m">                                <div class="row-m">                                    <div class="row-m">                                        <label>                                            Valor a receber                                        </label>                                        <span class="span_views">' . Check::ValorBr($Read->getResult()[0]['VLPAG']) . '</span>                                    </div>                                    <div class="row-m">                                        <label>                                            Valor pago                                        </label>                                      <span class="span_views">' . Check::ValorBr($Read->getResult()[0]['VLPAGO']) . '</span>                                    </div>                                </div>                            </div>                           '//                    "NCONT" => $Read->getResult()[0]['NCONT'],//                    "Npeddo" => $Read->getResult()[0]['Npeddo'],//                    "Nnota" => $Read->getResult()[0]['Nnota'],//                    "NDOC" => $Read->getResult()[0]['NDOC'],//                    "DESCRICAO" => $Read->getResult()[0]['DESCRICAO'],//                    "DEMIS" => $Read->getResult()[0]['DEMIS'],//                    "DVENC" => $Read->getResult()[0]['DVENC'],//                    "VLPAG" => $Read->getResult()[0]['VLPAG'],//                    "VLPAGO" => $Read->getResult()[0]['VLPAGO'],//                    "Situacao" => $Read->getResult()[0]['Situacao'],//                    "Unificados" => $Read->getResult()[0]['Unificados']                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;        case 'billstopay-views':            unset($data['action']);            $Code = (int) $data['code'];            $Read = new Read;            $Read->ExeRead("ctpag",                    "WHERE IdEmpresa = {$_SESSION['userlogin']['IdEmpresa']} AND NCONT = :c LIMIT 1",                    "c={$Code}");            if ($Read->getResult()) {                $json = array(                    "views" => true,                    "html" => '<div class="row-m">                                <div class="row-m">                                    <div class="row-m">                                        <label>                                            N° Controle                                        </label>                                        <span class="span_views">' . Check::DadosV($Read->getResult()[0]['NCONT']) . '</span>                                    </div>                                    <div class="row-m">                                        <label>                                            N° Pedido                                        </label>                                         <span class="span_views">' . Check::DadosV($Read->getResult()[0]['Npeddo']) . '</span>                                    </div>                                </div>                                <div class="row-m">                                    <div class="row-m">                                        <label>                                            N° Documento                                        </label>                                         <span class="span_views">' . Check::DadosV($Read->getResult()[0]['Nnota']) . '</span>                                    </div>                                    <div class="row-m">                                        <label>                                            N° Nota                                        </label>                                         <span class="span_views">' . Check::DadosV($Read->getResult()[0]['NDOC']) . '</span>                                    </div>                                </div>                            </div>                            <div class="row-m">                                <label>                                    Descrição                                </label>                                <span class="span_views">' . $Read->getResult()[0]['DESCRICAO'] . '</span>                            </div>                            <div class="row-m">                                <div class="row-m">                                    <div class="row-m">                                        <label>                                            Data de Emissão                                        </label>                                       <span class="span_views">' . Check::DataBr($Read->getResult()[0]['DEMIS']) . '</span>                                    </div>                                    <div class="row-m">                                        <label>                                            Data de Vencimento                                        </label>                                        <span class="span_views">' . Check::DataBr($Read->getResult()[0]['DVENC']) . '</span>                                    </div>                                </div>                                <div class="row-m">                                    <div class="row-m">                                        <label>                                            Valor a receber                                        </label>                                        <span class="span_views">' . Check::ValorBr($Read->getResult()[0]['VLPAG']) . '</span>                                    </div>                                    <div class="row-m">                                        <label>                                            Valor pago                                        </label>                                      <span class="span_views">' . Check::ValorBr($Read->getResult()[0]['VLPAGO']) . '</span>                                    </div>                                </div>                            </div>                            <div class="row-m">                                <div class="row-m">                                    <label>                                        Situação                                    </label>                                   <span class="span_views">' . Check::Situacao($Read->getResult()[0]['Situacao']) . '</span>                                </div>                            </div>'//                    "NCONT" => $Read->getResult()[0]['NCONT'],//                    "Npeddo" => $Read->getResult()[0]['Npeddo'],//                    "Nnota" => $Read->getResult()[0]['Nnota'],//                    "NDOC" => $Read->getResult()[0]['NDOC'],//                    "DESCRICAO" => $Read->getResult()[0]['DESCRICAO'],//                    "DEMIS" => $Read->getResult()[0]['DEMIS'],//                    "DVENC" => $Read->getResult()[0]['DVENC'],//                    "VLPAG" => $Read->getResult()[0]['VLPAG'],//                    "VLPAGO" => $Read->getResult()[0]['VLPAGO'],//                    "Situacao" => $Read->getResult()[0]['Situacao'],//                    "Unificados" => $Read->getResult()[0]['Unificados']                );                echo json_encode($json);                return;            }            $json["message"] = $Message->error("Produto não encontrado, tente novamente.")->render();            echo json_encode($json);            return;            break;    endswitch;endif;